---
title: "Dipteran dsRBP phylogenetics"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
  word_document: default
---
# Setting envinroment
```{r}
system('git config --global user.name "luciorq"')
system('git config --global user.email "luciorqueiroz@gmail.com"')
#system('git remote add origin https://github.com/luciorq/dsrbp_container_image.git')
#system('git remote add origin https://github.com/luciorq/dsrbp_container_image.git')
#system('git config remote.origin.url https://github.com/luciorq/dsrbp_container_image.git')
#system('git pull -u origin master')
#system('git push -u origin master')
```
## Testing libraries

## Initial tree
![Flavia's old tree](images/dsRBP_dipterans_v15.PDF)

# Analysis
## Loading libraries
```{r}
source("src/functions.R")
source("lib/rmd2rscript.R")
```
## Initializing variables
List of Files used for the analysis
Here you can change the files used for the analysis, inside 'raw' directory
```{r}
tblastn_db = "VB_dipteran_transcripts"
sequences_file = "teste1"
blastx_db = "FB_fly_translated"
```
# VectorBase tBlasn
## Transcripts used for tBlastn
tBlastn was performed against the following libraries:
```{r}
for(line in (readLines(paste0("raw/",tblastn_db,"_list.txt")))){
  print(unlist(strsplit(line, "/"))[length(unlist(strsplit(line, "/")))])
  }
```
### VectorBase sequences for tBlastn
```{r}
DownloadLibraries(tblastn_db)
makeBlastDB(tblastn_db,"nucl")
```
## tBlastn against VectorBase transcripts
```{r}
MLtoSLfasta(paste0("raw/",sequences_file))
Blast("tblastn",paste0("data/",sequences_file,".fasta"), tblastn_db)
```
### Formatting output
```{r}
tblastn_table <- read.csv(paste0("data/",sequences_file,".fasta_alignment.csv"), header = FALSE)
names(tblastn_table) <- c("querySeqId", "subjectSeqId", "queryLength", "alignmentLength", "E-value", "bitscore", "subjectTitle")
tblastn_table$subjectTitle <- unlist(lapply(tblastn_table$subjectTitle, function(x) strsplit(as.character(x), split = "|", fixed = TRUE)[[1]][1]))
tblastn_table <- subset(tblastn_table, (`E-value` < 1e-03))
head(tblastn_table)
```
### Retrieving hit fasta sequences
```{r}
write.table(tblastn_table$subjectSeqId, file = paste0("data/",sequences_file,"_ids.txt"),
            quote = FALSE, row.names = FALSE, col.names = FALSE)
RetrieveFasta(tblastn_db,sequences_file)
```

# FlyBase BlastX
## Translated Proteins used for reverse BlastX against Fruit Flies
```{r}
for(line in (readLines(paste0("raw/",blastx_db,"_list.txt")))){
  print(unlist(strsplit(line, "/"))[length(unlist(strsplit(line, "/")))])
  }
```
### FlyBase sequences for BlastX
```{r}
DownloadLibraries(blastx_db)
makeBlastDB(blastx_db, "prot")
```
## Reverse BlastX against fruit flies
```{r}
Blast("blastx",paste0("data/",sequences_file,"_blast_result.fasta"), blastx_db, outformat = 6)
```
### Formatting output
```{r}
system(paste0("sort -k1,1 -k6,6nr -k5,5n data/",sequences_file,"_blast_result.fasta_alignment.tab | sort -u -k 1,1 --merge > data/",sequences_file,"_filtered.tab"))
blastx_table <- read.table(paste0("data/",sequences_file,"_filtered.tab"), header = FALSE )
blastx_table$V7 <- blastx_table$V10
names(blastx_table) <- c("querySeqId", "subjectSeqId", "queryLength", "alignmentLength", "E-value", "bitscore", "subjectTitle")
blastx_table <- blastx_table[,1:7]
head(blastx_table)
```
### Formatting table
```{r}
reverse_blast_list = c()
reverse_evalue_list = c()
for(transcript in tblastn_table$subjectSeqId){
  i = 1
  for(hit in blastx_table$querySeqId){
    if(transcript == hit){
      title_name = as.character(blastx_table$subjectTitle[i])
      reverse_blast_list = c(reverse_blast_list, title_name)
      reverse_evalue = blastx_table$`E-value`[i]
      reverse_evalue_list = c(reverse_evalue_list, reverse_evalue)
    }
    i = i + 1
  }
  #print (transcript)
}
final_document <- tblastn_table[,c("querySeqId","subjectSeqId","E-value","subjectTitle")]
final_document$reverseBlast <- reverse_blast_list
final_document$reverseBlastEvalue <- reverse_evalue_list
#final_document <- subset(final_document, (`E-value` < 1e-03))
write.csv(final_document, file = paste0("results/",sequences_file,".csv"), row.names = FALSE)
final_document
```

### Retrieving transcripts fasta sequences
```{r}
write.table(final_document$subjectSeqId, file = paste0("data/",sequences_file,"final_ids.txt"),
            quote = FALSE, row.names = FALSE, col.names = FALSE)
RetrieveFasta(tblastn_db,paste0(sequences_file,"final"))
paste0("data/",sequences_file,"final_blast_result.fasta")
```




# INTERPRO Scan
## Batch InterProScan for `r sequences_file`
```{r}
RunIprScan((paste0("data/",sequences_file,".fasta")), 
           (paste0("data/iprscan_results/",sequences_file)))
```
```{r}
rmd2rscript("dsRBP.Rmd")
```


